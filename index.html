<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我們的國際創意市集：學習護照</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- 全局樣式 (維持不變) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f4f8; color: #333; line-height: 1.6; margin: 0; padding: 20px;
        }
        .passport-container {
            max-width: 900px; margin: 20px auto; background-color: #fff; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #ddd;
        }
        .passport-header {
            background-color: #4a69bd; color: white; padding: 20px 30px; text-align: center;
        }
        .passport-header h1 { margin: 0; font-size: 2em; letter-spacing: 2px; }
        .passport-header p { margin: 5px 0 0; opacity: 0.9; }
        .tab-nav { display: flex; background-color: #e2e8f0; border-bottom: 1px solid #cbd5e0; }
        .tab-button {
            flex: 1; padding: 15px 10px; border: none; background-color: transparent;
            cursor: pointer; font-size: 1em; font-weight: 600; color: #4a5568;
            transition: background-color 0.3s, color 0.3s; border-bottom: 3px solid transparent;
        }
        .tab-button:hover { background-color: #cbd5e0; }
        .tab-button.active { color: #4a69bd; border-bottom: 3px solid #4a69bd; background-color: #fff; }
        .tab-content { padding: 30px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .task-card {
            background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;
            padding: 20px; margin-bottom: 25px;
        }
        .task-card h2 { margin-top: 0; color: #1e3a8a; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        label { display: flex; align-items: center; font-weight: 600; margin-bottom: 8px; }
        label svg { width: 1.3em; height: 1.3em; margin-right: 10px; fill: #4a69bd; flex-shrink: 0; }
        input[type="text"], textarea {
            width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px;
            font-size: 1em; box-sizing: border-box; margin-bottom: 15px; background-color: #fff;
        }
        textarea { resize: vertical; min-height: 100px; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: #4a69bd; box-shadow: 0 0 0 2px rgba(74, 105, 189, 0.2); }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .action-button {
            display: block; width: 100%; padding: 15px; background-color: #3c5aa6;
            color: white; border: none; border-radius: 8px; font-size: 1.1em;
            font-weight: bold; cursor: pointer; text-align: center; margin-top: 30px;
            transition: background-color 0.3s;
        }
        .action-button:hover { background-color: #2d4373; }
        .action-button:disabled { background-color: #a0aec0; cursor: not-allowed; }

        /* 步驟 2: 新增 PDF 匯出專用樣式 */
        .pdf-export-mode .tab-nav, 
        .pdf-export-mode .action-button {
            display: none !important; /* 在匯出時隱藏所有導覽列和按鈕 */
        }
        .pdf-export-mode .tab-pane {
            display: none !important; /* 預設隱藏所有頁籤內容 */
        }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .tab-nav { flex-direction: column; }
            .tab-button { border-bottom: 1px solid #cbd5e0; }
            .tab-button.active { border-bottom: 3px solid #4a69bd; }
            .grid-container { grid-template-columns: 1fr; }
            .passport-header h1 { font-size: 1.5em; }
            .tab-content { padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="passport-container" id="passport-content">
        <header class="passport-header">
            <h1>我們的國際創意市集</h1>
            <p>學習護照 Learning Passport</p>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" data-tab="tab1">① 護照首頁</button>
            <button class="tab-button" data-tab="tab2">② 探索臺灣寶藏</button>
            <button class="tab-button" data-tab="tab3">③ 設計世界攤位</button>
            <button class="tab-button" data-tab="tab4">④ 市集日反思</button>
        </nav>

        <main class="tab-content">
            <!-- Tab 1: 護照首頁 -->
            <div id="tab1" class="tab-pane active">
                <div class="task-card">
                    <h2>護照持有人資訊 / Passport Holder Information</h2>
                    <div class="grid-container">
                        <div>
                            <label for="student-name">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                姓名 / Name
                            </label>
                            <input type="text" id="student-name" placeholder="請輸入2-4個繁體中文姓名">
                        </div>
                        <div>
                            <label for="group-members">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                小組成員 / Group Members
                            </label>
                            <input type="text" id="group-members" placeholder="請輸入所有組員的姓名">
                        </div>
                    </div>
                </div>
                 <div class="task-card">
                    <h2>旅程任務說明 / Journey Tasks Guide</h2>
                    <p>歡迎來到「我們的國際創意市集」！...</p>
                 </div>
                 <!-- 步驟 1: 修改HTML，加入獨立的下載按鈕 -->
                 <button class="action-button download-pdf-btn" data-target="tab1" data-filename-prefix="護照首頁">📄 下載「護照首頁」為 PDF</button>
            </div>

            <!-- Tab 2: 探索臺灣寶藏 -->
            <div id="tab2" class="tab-pane">
                <div class="task-card">
                    <h2>Step 1：臺灣好物腦力激盪</h2>
                    <textarea id="taiwan-ideas" placeholder="請盡情寫下所有想到的臺灣特色物品..."></textarea>
                </div>
                <div class="task-card">
                    <h2>Step 2：選定我們的「臺灣之光」</h2>
                    <input type="text" id="selected-item" placeholder="請填寫最終選定的產品名稱">
                    <textarea id="item-story" placeholder="請利用平板或圖書，查詢並記錄下它的故事..."></textarea>
                </div>
                <button class="action-button download-pdf-btn" data-target="tab2" data-filename-prefix="探索台灣寶藏">📄 下載「探索台灣寶藏」為 PDF</button>
            </div>

            <!-- Tab 3: 設計世界攤位 -->
            <div id="tab3" class="tab-pane">
                <!-- 內容省略以保持簡潔 -->
                <div class="task-card">...</div>
                <div class="task-card">...</div>
                <div class="task-card">...</div>
                <button class="action-button download-pdf-btn" data-target="tab3" data-filename-prefix="設計世界攤位">📄 下載「設計世界攤位」為 PDF</button>
            </div>
            
            <!-- Tab 4: 市集日反思 -->
            <div id="tab4" class="tab-pane">
                <!-- 內容省略以保持簡潔 -->
                <div class="task-card">...</div>
                <div class="task-card">...</div>
                <div class="task-card">...</div>
                <button class="action-button download-pdf-btn" data-target="tab4" data-filename-prefix="市集日反思">📄 下載「市集日反思」為 PDF</button>
            </div>
        </main>
        
        <!-- 移除最外層的統一按鈕 -->
    </div>

    <script>
        // --- 頁籤切換功能 (維持不變) ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // --- 步驟 3: 全面重構 PDF 生成與下載功能 ---
        const passportContainer = document.getElementById('passport-content');

        /**
         * 驗證姓名是否為 2-4 個繁體中文字
         * @param {string} name - 要驗證的姓名
         * @returns {boolean} - 是否通過驗證
         */
        function validateName(name) {
            // 這個正規表示式 ^[\u4e00-\u9fa5]{2,4}$ 的意思是：
            // ^ : 字串的開頭
            // [\u4e00-\u9fa5] : 任何一個在 Unicode CJK 統一漢字範圍內的字元
            // {2,4} : 前面的規則必須連續出現 2 到 4 次
            // $ : 字串的結尾
            const regex = /^[\u4e00-\u9fa5]{2,4}$/;
            return regex.test(name);
        }

        /**
         * 處理單一頁籤的 PDF 下載請求
         * @param {HTMLButtonElement} buttonElement - 被點擊的按鈕元素
         */
        async function handlePdfDownload(buttonElement) {
            const studentNameInput = document.getElementById('student-name');
            const studentName = studentNameInput.value.trim();

            // 1. 執行姓名驗證
            if (!validateName(studentName)) {
                alert('姓名輸入錯誤！\n請在「護照首頁」的姓名欄位中，輸入 2 至 4 個繁體中文字。');
                studentNameInput.focus(); // 讓使用者方便修改
                return; // 中斷執行
            }

            // 從按鈕的 data-* 屬性獲取資訊
            const targetPaneId = buttonElement.dataset.target;
            const fileNamePrefix = buttonElement.dataset.filenamePrefix;
            const targetPane = document.getElementById(targetPaneId);
            
            if (!targetPane) return;

            // 暫時禁用按鈕
            buttonElement.disabled = true;
            buttonElement.innerText = 'PDF 產生中...';

            // 2. 準備 PDF 內容
            // 加上專用 class 來隱藏不必要的元素
            passportContainer.classList.add('pdf-export-mode');
            // 強制顯示我們要匯出的那一頁
            targetPane.style.display = 'block';

            // 3. 設定 PDF 檔名與選項
            const fileName = `${fileNamePrefix}_${studentName}.pdf`;
            const options = {
                margin:       [0.5, 0.5, 0.5, 0.5],
                filename:     fileName,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            try {
                // 4. 生成並下載 PDF
                // 核心：html2pdf 只會捕捉 `passportContainer` 內目前可見的內容來生成PDF
                await html2pdf().from(passportContainer).set(options).save();
            } catch (error) {
                console.error("PDF 生成失敗:", error);
                alert("抱歉，PDF 檔案生成失敗，請稍後再試。");
            } finally {
                // 5. 清理戰場：無論成功或失敗，都恢復頁面原樣
                passportContainer.classList.remove('pdf-export-mode');
                targetPane.style.display = ''; // 移除內聯樣式，讓 CSS 接管

                // 恢復按鈕
                buttonElement.disabled = false;
                buttonElement.innerText = `📄 下載「${fileNamePrefix}」為 PDF`;
            }
        }

        // 為所有具有 .download-pdf-btn class 的按鈕綁定點擊事件
        document.querySelectorAll('.download-pdf-btn').forEach(button => {
            button.addEventListener('click', () => handlePdfDownload(button));
        });
    </script>

</body>
</html>
